#! /bin/sh
#
#  File - configure-ec2
#
#  Purpose - (Re-)configure an AWS EC2 instance as needed until we ascend the
#            AMI learning curve.
#
#  Author - Andy Halper <ashalper@usgs.gov>
#

# additional packages that don't come with the vanilla OWI CentOS
# template
yum -y install emacs npm nodejs lynx ruby wget \
    http://s3.amazonaws.com/ec2-downloads/ec2-ami-tools.noarch.rpm &
yum=$!

# installation directories and groups
mkdir -p -m 700 /usr/local/lib/aquarius-token /usr/local/lib/aq2rdb
groupadd owi
chgrp owi /usr/local/lib/aquarius-token /usr/local/lib/aq2rdb

# add ec2-user to owi group
usermod -a -G owi ec2-user

# http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/creating-an-ami-instance-store.html#creating-ami-linux-instance
mkdir /tmp/cert && chmod 771 /tmp/cert && chown ec2-user /tmp/cert && \
    chgrp ec2-user /tmp/cert

# verify installation of AMI Tools
# http://docs.aws.amazon.com/AWSEC2/latest/CommandLineReference/set-up-ami-tools.html
wait $yum			# wait for yum (above) to finish
ec2-ami-tools-version

# set up Amazon EC2 CLI Tools
# http://docs.aws.amazon.com/AWSEC2/latest/CommandLineReference/set-up-ec2-cli-linux.html#setting_up_ec2_command_linux
wget http://s3.amazonaws.com/ec2-downloads/ec2-api-tools.zip
mkdir /usr/local/ec2
unzip ec2-api-tools.zip -d /usr/local/ec2

echo <<EOF
After the X.509 certificate is uploaded to /tmp/cert, run the command:

sudo /usr/local/bin/ec2-bundle-vol -k /tmp/cert/aws-private-key.pem -c /tmp/cert/aws-certificate.pem -u 437575011997 -r x86_64 -e /tmp/cert

to create the AMI, then:

ec2-upload-bundle -b aqcu/aq2rdb/ami --region us-west-2 -m /tmp/image.manifest.xml

to upload it to S3, then finally:

 ec2-register aqcu/aq2rdb/ami/image.manifest.xml -n aq2rdb -d 'CentOS 6.7 instance configured to host aquarius-token & aq2rdb.' --region us-west-2

to register it.

EOF
