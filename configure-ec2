#! /bin/sh
#
#  File - configure-ec2
#
#  Purpose - (Re-)configure an AWS EC2 instance as needed until we ascend the
#            AMI learning curve.
#
#  Author - Andy Halper <ashalper@usgs.gov>
#

# additional packages that don't come with the vanilla OWI CentOS
# template
yum -y install emacs npm nodejs lynx ruby wget

# installation directories and groups
mkdir -p -m 700 /usr/local/lib/aquarius-token /usr/local/lib/aq2rdb
groupadd owi
chgrp owi /usr/local/lib/aquarius-token /usr/local/lib/aq2rdb

# add ec2-user to owi group
usermod -a -G owi ec2-user

# http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/creating-an-ami-instance-store.html#creating-ami-linux-instance
mkdir /tmp/cert && chmod 771 /tmp/cert && chown ec2-user /tmp/cert && \
    chgrp ec2-user /tmp/cert

# set up AMI Tools
# http://docs.aws.amazon.com/AWSEC2/latest/CommandLineReference/set-up-ami-tools.html
yum -y install http://s3.amazonaws.com/ec2-downloads/ec2-ami-tools.noarch.rpm
ec2-ami-tools-version

echo <<EOF
After the X.509 certificate is uploaded to /tmp/cert, run the command:

/usr/local/bin/ec2-bundle-vol -k /tmp/cert/aws-certificate.pem \
-c /tmp/cert/aws-certificate.pem \
-u 'arn:aws:iam::437575011997:user/ashalper' -r x86_64 -e /tmp/cert

to create the AMI.
EOF
